!IF "$(OS)" == "Windows_NT"
NULL=
!ELSE
NULL=nul
!ENDIF

OBJDIR = ..\..\obj\bcc\fmp\addressbook
DLLDIR = ..\..\bin\FMP\AddressBook
DLLNAME = $(DLLDIR)\addressbook.bcc.fmp

CC = bcc32
CFLAGS = -tWD -d -a2 -M- -K -v- -RT- -u- -x- -k- -O1
LFLAGS = /x /Gn /Tpd /aa
CP = copy /y
M4 = m4 -P -DCMD=..\FARMail\gen_date.exe
DOCS = $(DLLDIR)\example.adr $(DLLDIR)\addressbook.fml $(DLLDIR)\addressbooke.hlf $(DLLDIR)\addressbookr.hlf

all: $(OBJDIR) $(DLLDIR) $(DLLNAME) $(DOCS)

OBJS = $(OBJDIR)\memory.obj \
       $(OBJDIR)\registry.obj \
       $(OBJDIR)\addressbook.obj \
       $(OBJDIR)\bcc_entry_point.obj

$(OBJDIR)\memory.obj: memory.cpp memory.hpp
$(OBJDIR)\registry.obj: registry.cpp plugin.hpp registry.hpp
$(OBJDIR)\addressbook.obj: addressbook.cpp plugin.hpp ..\FARMail\fmp.hpp memory.hpp language.hpp registry.hpp
$(OBJDIR)\bcc_entry_point.obj: bcc_entry_point.asm

.cpp.obj:
	@echo compiling $<
	@$(CC) $(CFLAGS) -n$(OBJDIR) -c $&.cpp

.asm.obj:
	@echo compiling $<
	@$(CC) -n$(OBJDIR) -c $&.asm

$(DLLNAME): $(OBJS)
	@echo linking
	@ilink32.exe $(LFLAGS) $**,$(DLLNAME),,Import32.lib,
	@del $(DLLDIR)\*.tds

$(DLLDIR)\addressbook.fml: addressbook.fml
	@$(CP) addressbook.fml $@
$(DLLDIR)\addressbooke.hlf: addressbooke.hlf.m4 ..\FARMail\fm_version.m4
	@$(M4) addressbooke.hlf.m4 > $@
$(DLLDIR)\addressbookr.hlf: addressbookr.hlf.m4 ..\FARMail\fm_version.m4
	@$(M4) addressbookr.hlf.m4 > $@
$(DLLDIR)\example.adr: example.adr
	@$(CP) example.adr $@

$(OBJDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"
$(DLLDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"

clean:
	@del $(OBJS)