!IF "$(OS)" == "Windows_NT"
NULL=
!ELSE
NULL=nul
!ENDIF

OBJDIR = ..\..\obj\bcc\fmp\filter
DLLDIR = ..\..\bin\FMP\Filter
FILTERSDIR = $(DLLDIR)\FILTERS
DLLNAME = $(DLLDIR)\filter.bcc.fmp

CC = bcc32
CFLAGS = -tWD -d -a2 -M- -K -v- -RT- -u- -x- -k- -O1
LFLAGS = /x /Gn /Tpd /aa
CP = copy /y
M4 = m4 -P -DCMD=..\FARMail\gen_date.exe
DOCS = $(DLLDIR)\filter.fml $(DLLDIR)\filtere.hlf $(DLLDIR)\filterr.hlf
FILTERS = $(FILTERSDIR)\example.fmf

all: $(OBJDIR) $(DLLDIR) $(FILTERSDIR) $(DLLNAME) $(DOCS) $(FILTERS)

OBJS = $(OBJDIR)\memory.obj \
       $(OBJDIR)\crt_file.obj \
       $(OBJDIR)\filter_utils.obj \
       $(OBJDIR)\registry.obj \
       $(OBJDIR)\filter.obj \
       $(OBJDIR)\bcc_entry_point.obj

$(OBJDIR)\filter.obj: filter.cpp plugin.hpp ..\FARMail\fmp.hpp filter.hpp registry.cpp
$(OBJDIR)\crt_file.obj: crt_file.cpp
$(OBJDIR)\filter_utils.obj: filter_utils.cpp plugin.hpp memory.hpp filter.hpp ..\FARMail\fmp.hpp
$(OBJDIR)\memory.obj: memory.cpp memory.hpp
$(OBJDIR)\registry.obj: registry.cpp plugin.hpp registry.hpp
$(OBJDIR)\bcc_entry_point.obj: bcc_entry_point.asm

.cpp.obj:
	@echo compiling $<
	@$(CC) $(CFLAGS) -n$(OBJDIR) -c $&.cpp

.asm.obj:
	@echo compiling $<
	@$(CC) -n$(OBJDIR) -c $&.asm

$(DLLNAME): $(OBJS)
	@echo linking
	@ilink32.exe $(LFLAGS) $**,$(DLLNAME),,Import32.lib,
	@del $(DLLDIR)\*.tds

$(DLLDIR)\filter.fml: filter.fml
	@$(CP) filter.fml $@
$(DLLDIR)\filtere.hlf: filtere.hlf.m4 ..\FARMail\fm_version.m4
	@$(M4) filtere.hlf.m4 > $@
$(DLLDIR)\filterr.hlf: filterr.hlf.m4 ..\FARMail\fm_version.m4
	@$(M4) filterr.hlf.m4 > $@
$(FILTERSDIR)\example.fmf: example.fmf
	@$(CP) example.fmf $@

$(OBJDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"
$(DLLDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"
$(FILTERSDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"

clean:
	@del $(OBJS)
