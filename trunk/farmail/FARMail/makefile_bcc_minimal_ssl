!IF "$(OS)" == "Windows_NT"
NULL=
!ELSE
NULL=nul
!ENDIF

OBJDIR = ..\..\obj\bcc\ssl\minimal
DLLDIR = ..\..\bin
EXTRADIR = $(DLLDIR)\Extra
DLLNAME = $(DLLDIR)\farmail.bcc_ssl_minimal.dll

CC = bcc32
CFLAGS = -tWD -d -a2 -M- -K -v- -RT- -u -x- -xd- -y- -O1 -DFARMAIL_SSL
LFLAGS = /x /Gn /Tpd /aa
CP = copy /y
M4 = m4 -P -DCMD=gen_date.exe
DOCS = $(DLLDIR)\farmaile.lng $(DLLDIR)\farmailr.lng $(DLLDIR)\farmaile.hlf $(DLLDIR)\farmailr.hlf $(DLLDIR)\file_id.diz $(DLLDIR)\readme.eng.txt $(DLLDIR)\readme.rus.txt $(DLLDIR)\history.eng.txt $(DLLDIR)\history.rus.txt
EXTRAS = $(EXTRADIR)\fms-4ever.hrc $(EXTRADIR)\fms-take5.hrc $(EXTRADIR)\PluginHotkeys.reg $(EXTRADIR)\Script.reg $(EXTRADIR)\esc_message.xml

all: $(OBJDIR) gen_date.exe gen_date $(DLLDIR) $(EXTRADIR) $(DLLNAME) $(DOCS) $(EXTRAS)
new: $(OBJDIR) gen_date.exe inc_build $(DLLDIR) $(EXTRADIR) $(DLLNAME) $(DOCS) $(EXTRAS)

OBJS = $(OBJDIR)\farmail.obj \
       $(OBJDIR)\base64.obj \
       $(OBJDIR)\cache.obj \
       $(OBJDIR)\charset.obj \
       $(OBJDIR)\config.obj \
       $(OBJDIR)\config_encodings.obj \
       $(OBJDIR)\crt.obj \
       $(OBJDIR)\crt_file.obj \
       $(OBJDIR)\editsend.obj \
       $(OBJDIR)\fastdownload.obj \
       $(OBJDIR)\fmclass.obj \
       $(OBJDIR)\fmp_api.obj \
       $(OBJDIR)\fmp_class.obj \
       $(OBJDIR)\header.obj \
       $(OBJDIR)\headerlist.obj \
       $(OBJDIR)\imapclnt.obj \
       $(OBJDIR)\mailbox.obj \
       $(OBJDIR)\mailclnt.obj \
       $(OBJDIR)\memory.obj \
       $(OBJDIR)\multiprt.obj \
       $(OBJDIR)\password.obj \
       $(OBJDIR)\progress.obj \
       $(OBJDIR)\registry.obj \
       $(OBJDIR)\rfc1522.obj \
       $(OBJDIR)\savefile.obj \
       $(OBJDIR)\smtp.obj \
       $(OBJDIR)\smtpdlg.obj \
       $(OBJDIR)\socket2.obj \
       $(OBJDIR)\smtpdlgex.obj \
       $(OBJDIR)\bcc_entry_point.obj

$(OBJDIR)\base64.obj: base64.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\cache.obj: cache.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\charset.obj: charset.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\config.obj: config.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\config_encodings.obj: config_encodings.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\crt.obj: crt.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\crt_file.obj: crt_file.cpp crt_file.hpp
$(OBJDIR)\editsend.obj: editsend.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\farmail.obj: farmail.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp crt_file.hpp fmp_internal.hpp
$(OBJDIR)\fastdownload.obj: fastdownload.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\fmclass.obj: fmclass.cpp farmail.hpp plugin.hpp memory.hpp language.hpp version.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\fmp_api.obj: fmp_api.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp fmp.hpp version.hpp
$(OBJDIR)\fmp_class.obj: fmp_class.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp fmp.hpp
$(OBJDIR)\header.obj: header.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp crt_file.hpp fmp_internal.hpp
$(OBJDIR)\headerlist.obj: headerlist.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\imapclnt.obj: imapclnt.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp progress.hpp
$(OBJDIR)\mailbox.obj: mailbox.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\mailclnt.obj: mailclnt.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp progress.hpp
$(OBJDIR)\memory.obj: memory.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\multiprt.obj: multiprt.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\password.obj: password.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\progress.obj: progress.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp progress.hpp
$(OBJDIR)\registry.obj: registry.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\rfc1522.obj: rfc1522.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\savefile.obj: savefile.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\smtp.obj: smtp.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\smtpdlg.obj: smtpdlg.cpp farmail.hpp plugin.hpp memory.hpp language.hpp farkeys.hpp version.hpp crt.hpp crt_file.hpp fmp_internal.hpp progress.hpp
$(OBJDIR)\smtpdlgex.obj: smtpdlgex.cpp farmail.hpp plugin.hpp memory.hpp language.hpp farkeys.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\socket2.obj: socket2.cpp farmail.hpp plugin.hpp memory.hpp language.hpp crt.hpp fmp_internal.hpp
$(OBJDIR)\bcc_entry_point.obj: bcc_entry_point.asm

.cpp.obj:
	@echo compiling $<
	@$(CC) $(CFLAGS) -n$(OBJDIR) -c $&.cpp

.asm.obj:
	@echo compiling $<
	@$(CC) -n$(OBJDIR) -c $&.asm

$(DLLNAME): $(OBJS)
	@echo linking
	@ilink32.exe $(LFLAGS) $**,$(DLLNAME),,Import32.lib libeay32.lib libssl32.lib,
	@del $(DLLDIR)\*.tds

version.hpp: version.hpp.m4 fm_version.m4
	@$(M4) version.hpp.m4 > $@

$(DLLDIR)\farmaile.lng: farmaile.lng
	@$(CP) farmaile.lng $@
$(DLLDIR)\farmailr.lng: farmailr.lng
	@$(CP) farmailr.lng $@
$(DLLDIR)\farmaile.hlf: farmaile.hlf.m4 fm_version.m4
	@$(M4) farmaile.hlf.m4 > $@
$(DLLDIR)\farmailr.hlf: farmailr.hlf.m4 fm_version.m4
	@$(M4) farmailr.hlf.m4 > $@
$(DLLDIR)\file_id.diz: file_id.diz.m4 fm_version.m4
	@$(M4) file_id.diz.m4 > $@
$(DLLDIR)\readme.eng.txt: readme.eng.txt.m4 fm_version.m4
	@$(M4) readme.eng.txt.m4 > $@
$(DLLDIR)\readme.rus.txt: readme.rus.txt.m4 fm_version.m4
	@$(M4) readme.rus.txt.m4 > $@
$(DLLDIR)\history.eng.txt: history.eng.txt
	@$(CP) history.eng.txt $@
$(DLLDIR)\history.rus.txt: history.rus.txt
	@$(CP) history.rus.txt $@
$(EXTRADIR)\fms-4ever.hrc: fms-4ever.hrc
	@$(CP) fms-4ever.hrc $@
$(EXTRADIR)\fms-take5.hrc: fms-take5.hrc
	@$(CP) fms-take5.hrc $@
$(EXTRADIR)\PluginHotkeys.reg: PluginHotkeys.reg
	@$(CP) PluginHotkeys.reg $@
$(EXTRADIR)\PluginMacroses.reg: PluginMacroses.reg
	@$(CP) PluginMacroses.reg $@
$(EXTRADIR)\PluginMacroses.reg: PluginMacroses.reg
	@$(CP) PluginMacroses.reg $@
$(EXTRADIR)\Script.reg: Script.reg
	@$(CP) Script.reg $@
$(EXTRADIR)\esc_message.xml: esc_message.xml
	@$(CP) esc_message.xml $@

$(OBJDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"
$(DLLDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"
$(EXTRADIR):
	@if not exist "$@\$(NULL)" mkdir "$@"

inc_build:
	@echo setting build information (increase build number)
	@d.bat fm_version.m4 silent
	@gen_date.exe fm_version.m4 x

gen_date:
	@echo setting build information
	@gen_date.exe fm_version.m4

$(OBJDIR)\gen_date.obj: gen_date.c
	@$(CC) -n$(OBJDIR) -c gen_date.c

gen_date.exe: $(OBJDIR)\gen_date.obj
	@ilink32.exe /x /Gn /ap $(OBJDIR)\gen_date.obj c0x32.obj,gen_date.exe,,cw32.lib Import32.lib,
	@del gen_date.tds

clean:
	@echo cleaning up
	@del $(OBJS)
	@del $(OBJDIR)\gen_date.obj
