!IF "$(OS)" == "Windows_NT"
NULL=
!ELSE
NULL=nul
!ENDIF

OBJDIR = ..\..\obj\bcc\fmp\openattach
DLLDIR = ..\..\bin\FMP\OpenAttach
DLLNAME = $(DLLDIR)\open_attach.bcc.fmp

CC = bcc32
CFLAGS = -tWD -d -a2 -M- -K -v- -RT- -u- -x- -k- -O1
LFLAGS = /x /Gn /Tpd /aa
CP = copy /y
M4 = m4 -P -DCMD=..\FARMail\gen_date.exe
DOCS = $(DLLDIR)\open_attach.fml

all: $(OBJDIR) $(DLLDIR) $(DLLNAME) $(DOCS)

OBJS = $(OBJDIR)\open_attach.obj \
       $(OBJDIR)\bcc_entry_point.obj

$(OBJDIR)\open_attach.obj: open_attach.cpp memory.h plugin.hpp ..\FARMail\fmp.hpp
$(OBJDIR)\bcc_entry_point.obj: bcc_entry_point.asm

.cpp.obj:
	@echo compiling $<
	@$(CC) $(CFLAGS) -n$(OBJDIR) -c $&.cpp

.asm.obj:
	@echo compiling $<
	@$(CC) -n$(OBJDIR) -c $&.asm

$(DLLNAME): $(OBJS)
	@echo linking
	@ilink32.exe $(LFLAGS) $**,$(DLLNAME),,Import32.lib,
	@del $(DLLDIR)\*.tds

$(DLLDIR)\open_attach.fml: open_attach.fml
	@$(CP) open_attach.fml $@

$(OBJDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"
$(DLLDIR):
	@if not exist "$@\$(NULL)" mkdir "$@"

clean:
	@del $(OBJS)
